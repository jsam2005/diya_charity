<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /

# CRITICAL: Don't rewrite API requests - MUST be FIRST
RewriteCond %{REQUEST_URI} ^/api(/.*)?$ [NC]
RewriteRule . - [L]

# CRITICAL: Don't rewrite assets - prevent redirects that cause CORS
# This ensures assets load from the same domain (www or non-www)
RewriteCond %{REQUEST_URI} ^/assets(/.*)?$ [NC]
RewriteRule . - [L]

# Allow SSL/ACME validation files (.well-known) to bypass SPA routing
RewriteCond %{REQUEST_URI} ^/\.well-known(/.*)?$ [NC]
RewriteRule . - [L]

# Redirect non-www to www (for consistency and SSL coverage)
RewriteCond %{HTTP_HOST} ^dctnow\.ngo$ [NC]
RewriteRule ^(.*)$ https://www.dctnow.ngo/$1 [R=301,L]

# Force HTTPS (if not already)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Don't rewrite if file exists (assets, images, etc.)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule . - [L]

# Don't rewrite if directory exists
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule . - [L]

# React Router - route everything else to index.html
RewriteRule . /index.html [L]
</IfModule>

# Force MIME type for JavaScript files - try multiple methods
<IfModule mod_mime.c>
  RemoveType .js
  AddType application/javascript .js
  AddType application/javascript .mjs
</IfModule>

# Alternative: Use FilesMatch to force type
<FilesMatch "\.js$">
  SetHandler default-handler
  ForceType application/javascript
</FilesMatch>

# Fix QUIC/HTTP3 and SSL issues + Cache Prevention
<IfModule mod_headers.c>
    # Disable QUIC/HTTP3 to prevent protocol errors
    Header always set Alt-Svc "clear"
    
    # Connection keep-alive
    Header always set Connection "keep-alive"
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # CRITICAL: Prevent caching of index.html to avoid hash mismatch issues
    # This ensures browsers always fetch the latest index.html with correct JS file references
    <FilesMatch "^(index\.html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>
